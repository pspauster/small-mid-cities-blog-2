---
title: "A Class of Their Own: Supportive Housing in Small and Mid-Size Cities"
subtitle: "NYU Furman Center"
author: "Patrick Spauster"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    code_folding: show
---

The analysis presented here appears in the blog post [_Supportive Housing Small and Mid-Sized Cities
_](link)

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  out.width = "100%",
  fig.height = 7
)
```


#### Add libraries and formats
```{r load-packages-set-options}
library(tidyverse) # general data manipulation and graphing
library(reshape2)
library(lubridate) # format dates
library(scales) # number formatting
library(janitor) # data cleaning
library(hrbrthemes)
library(gt) # formatting tables
library(tidycensus) # pulling in census data
library(jsonlite)
library(ggplot2) # making graphs
library(acssf)
library(ggrepel)
library(getarc)
library(fs)
library(curl)
library(readxl)
library(sf)
library(urbnthemes)
library(rvest)

set_urbn_defaults()

sf::sf_use_s2(FALSE)
options(tigris_use_cache = TRUE)
options(scipen = 999)

# Creating a color blind friendly palette using https://colorbrewer2.org/#type=diverging&scheme=BrBG&n=4
city_size_pal <- c(
  "#a6611a",
  "#dfc27d",
  "#018571",
  "#80cdc1"
)

```

## Defining External Variables
 To access 2019 ACS data, we use the US Census Bureau's API, which requires an access key.
```{r}

### Census API Key
# Input your census API key below to access the census data. You can sign-up for a key here:https://api.census.gov/data/key_signup.html
census_api_key = "2a8badf7045fdf93b91b5c21b184939b04cffb09"

```


## Data Pull


#### 5-Year American Community Survey (ACS) Data 2015-2019
For this blog post we use the American Community Survey 5-year estimate data for 2015 to 2019. 
```{r message=FALSE, output=FALSE, warning=FALSE, echo= FALSE, results='hide'}
# Searching census codes
v19 <- load_variables(2019, "acs5", cache = TRUE)

my_states <- state.abb

# Pull in census variables
census_2019 <- get_acs(
  geography = "place",
  year = 2019,
  survey = "acs5",
  output = "wide",
  state = my_states,
  geometry = TRUE,
  #moe_sum = FALSE,
  variables = c(
    "B01003_001E", # pop_num,
    "B03002_006E", # pop_race_asian_num
    "B03002_004E", # pop_race_black_num
    "B03002_012E", # pop_race_hisp_num
    "B03002_003E", # pop_race_white_num
    acs_vars("B01001_{c(3:6, 27:30)*}E"), # pop_u18_num
    acs_vars("B01001_{c(20:25, 44:49)*}E"), # pop_65p_num
    acs_vars("B01001_{c(7:19, 31:43)*}E"),
    "B17001_002E", # pop_pov_num
    "B25002_002E", # unit_occ_num
    "B25003_002E", # unit_occ_own_num
    "B25003_003E", # unit_occ_rent_num
    "B25063_002E", # unit_rent_cash_num
    acs_vars("B25070_{7:10*}E"), # rent_burden_num
    "B25002_001E", # unit_num
    "B25002_003E", # unit_vac_num
    "B25064_001E", # rent_gross_med
    "B25119_001E", # hh_inc_med
    "B25070_010E", # rent_burden_sev_num
    "B19025_001E", # aggregate_hh_income
    "B17001_001E", # pop_pov_denom_num
    "B19025_001E", # aggregate_hh_income_est
    "B19001_001E", # hh_income_count_est summary variable
    "B25024_001E", # total_units
    "B25024_002E", # total_1_det
    "B25024_003E", # total_1_att
    "B25032_013E", # 	total_units_rent
    "B25032_014", # units_rent_1_det
    "B25032_015E", # units_rent_1_att
    "B25106_025E", # count_less20K_est
    "B25106_028E", # cost_burden_less20K_est
    "B25106_029E", # count_20K34k_est
    "B25106_032E", # cost_burden_20K34k_est
    "B25106_033E", # count_35K49k_est
    "B25106_036E", # cost_burden_35K49k_est
    "B25106_037E", # count_50K74k_est
    "B25106_040E", # cost_burden_50K74k_est
    "B25106_041E", # count_more75k_est
    "B25106_044E", # cost_burden_more75k_est
    "B25003H_002E", # homeowner_nonHisp_white_est
    "B25003H_001E", # count_nonHisp_white_est
    "B25003B_002E", # homeowner_Black_est
    "B25003B_001E", # count_Black_est
    "B25003D_002E", # homeowner_Asian_est
    "B25003D_001E", # count_Asian_est
    "B25003I_002E", # homeowner_Latino_est
    "B25003I_001E" # count_Latino_est
  )
) %>%
  mutate(
    "pop_u18_num" = acs_est_sum("B01001_{c(3:6, 27:30)*}E"),
    "pop_65p_num" = acs_est_sum("B01001_{c(20:25, 44:49)*}E"),
    "pop_18_64_num" = acs_est_sum("B01001_{c(7:19, 31:43)*}E"),
    "rent_burden_num" = acs_est_sum("B25070_{7:10*}E")
  )
# Assign places to city size categories for the analysis
census_2019 <- census_2019 %>%
  mutate(size_type = case_when(
    B01003_001E >= 50000 & B01003_001E < 100000 ~ "small (50-100k)",
    B01003_001E >= 100000 & B01003_001E < 150000 ~ "small-mid (100-150k)",
    B01003_001E >= 150000 & B01003_001E < 500000 ~ "mid (150-500k)",
    B01003_001E >= 500000 ~ "large (500k +)"
  )) %>%
  filter(!is.na(size_type))

# Select variables needed for the analysis below
census_2019 <- census_2019 %>%
  select(
    geoid = "GEOID",
    NAME,
    pop_num =  "B01003_001E", 
    pop_race_asian_num = "B03002_006E", 
    pop_race_black_num = "B03002_004E", 
    pop_race_hisp_num = "B03002_012E", 
    pop_race_white_num  = "B03002_003E", 
    pop_pov_num = "B17001_002E", 
    unit_occ_num = "B25002_002E", 
    unit_occ_own_num = "B25003_002E", 
    unit_occ_rent_num = "B25003_003E", 
    unit_rent_cash_num = "B25063_002E", 
    unit_num = "B25002_001E", 
    unit_vac_num = "B25002_003E", 
    hh_inc_med = "B25119_001E", 
    rent_burden_sev_num = "B25070_010E", 
    pop_pov_denom_num = "B17001_001E", 
    rent_gross_med = "B25064_001E", 
    aggregate_hh_income_est = "B19025_001E", 
    hh_income_count_est = "B19001_001E", 
    "pop_u18_num", 
    "pop_65p_num", 
    "pop_18_64_num", 
    "rent_burden_num", 
    total_units = "B25024_001E", 
    total_1_det = "B25024_002E", 
    total_1_att = "B25024_003E", 
    total_units_rent = "B25032_013E", 
    units_rent_1_det = "B25032_014E", 
    units_rent_1_att = "B25032_015E", 
    count_less20K_est = "B25106_025E", 
    cost_burden_less20K_est = "B25106_028E", 
    count_20K34k_est = "B25106_029E", 
    cost_burden_20K34k_est = "B25106_032E", 
    count_35K49k_est = "B25106_033E", 
    cost_burden_35K49k_est = "B25106_036E", 
    count_50K74k_est = "B25106_037E", 
    cost_burden_50K74k_est = "B25106_040E",
    count_more75k_est = "B25106_041E",
    cost_burden_more75k_est = "B25106_044E", 
    homeowner_nonHisp_white_est = "B25003H_002E", 
    count_nonHisp_white_est = "B25003H_001E", 
    homeowner_Black_est = "B25003B_002E", 
    count_Black_est = "B25003B_001E", 
    homeowner_Asian_est = "B25003D_002E", 
    count_Asian_est = "B25003D_001E", 
    homeowner_Latino_est = "B25003I_002E", 
    count_Latino_est = "B25003I_001E", 
    "size_type"
  )

```

## Exclude Cities
In this analysis, we drop cities that are outside of the 50-states and DC (e.g., in the US Territories). We also exclude cities that are newly established since the 2000 Census and those that merged with their county jurisdiction to form a unified government during that period as well, so that we have a consistent sample of cities for the analysis. 

```{r}
# Dropping cities that were not included in the 2000 census, cities outside the 50-states, and those that merged with their county jurisdiction to form a unified government over the period.
exclude <- c("0464210", "0621230", "0637692", "0646842", "0812815", "1200410", "1245060", "1310944", "1319000", "1342425", "1349008", "1372122", "1373784", "1571550", "2148006", "2578972", "2483775", "5103320", "5367167", "1271625", "7276770", "7206593", "7214290", "7263820", "7210334", "7232522", "7252431" )

small_mid_explore <- filter(as.data.frame(census_2019), ! geoid %in% exclude)
```

## Wrangling Data

### Get Data on PHA Geographies

We will match city level data to PHA geographies from the HUD Estimated Housing Authority Service Areas from PD&R (https://hudgis-hud.opendata.arcgis.com/datasets/HUD::estimated-housing-authority-service-areas/about)

```{r}

pha_geo <- query_layer(endpoint = "https://services.arcgis.com/VTyQ9soqVukalItT/arcgis/rest/services/Proposed_Housing_Authority_Service_Areas/FeatureServer/0") %>% 
  mutate(pha_level = factor(
    case_when(
    SUMLEV == "050" ~ "Regional",
    SUMLEV == "040" ~ "State",
    SUMLEV == "160" ~ "Local"
  ),
    levels = c("Local", "Regional", "State"))) %>% 
  clean_names()

pha_geo %>% as.data.frame() %>% count(pha_level) #36 total state PHAs

pha_geo %>% as.data.frame() %>% filter(pha_level == "State") %>%  count(stusab) #31 states have a state PHA

```


### Get Picture of Subsidized Households Data

We will match PHA and place level subsidized households data from HUD (https://www.huduser.gov/portal/datasets/assthsg.html#2009-2020_data) to describe housing assistance in each city


```{r}

#before downloading, ensure you are in the correct working directory with getwd() and setwd()

pic_year <- 2020

# Download Files ----------------------------------------------------------

pic_url_base <- "https://www.huduser.gov/portal/datasets/pictures"

download.file(str_glue("{pic_url_base}/dictionary_{pic_year}.pdf"),
              destfile = str_glue("dictionary_{pic_year}.pdf"),
              mode = "wb")
download.file(str_glue("{pic_url_base}/files/PLACE_{pic_year}.xlsx"),
              destfile = str_glue("PLACE_{pic_year}.xlsx"),
              mode = "wb")
download.file(str_glue("{pic_url_base}/files/PHA_{pic_year}.xlsx"),
              destfile = str_glue("PHA_{pic_year}.xlsx"),
              mode = "wb")


psh_places <- str_glue("PLACE_{pic_year}.xlsx") %>% 
  read_xlsx()

psh_phas <- str_glue("PHA_{pic_year}.xlsx") %>% #there's no PB S8 in these data for some reason
  read_excel() %>% 
  rename(PARTICIPANT_CODE = code)

```

### Add MTW flag
```{r}

mtw_phas <- "https://www.hud.gov/program_offices/public_indian_housing/programs/ph/mtw/mtwagencies" %>% 
  read_html() %>% 
  html_nodes("table") %>% 
  .[[1]] %>% 
  html_table(fill=TRUE, header = TRUE) %>% 
  clean_names() %>% 
  mutate(state_ab = str_sub(mtw_agencies_and_state_location, start = -3, end = -2),
         pha_name = tolower(str_sub(mtw_agencies_and_state_location, start = 1, end = -6)),
         mtw_flag = 1) %>% 
  select(state_ab, pha_name, mtw_flag) %>% 
  mutate(pha_name = case_when( #fix names from link to match psh data
    pha_name == "auburn housing authority" ~ "ha auburn",
    pha_name == "brighton housing authority" ~ "housing authority of the city of brighton",
    pha_name == "bristol redevelopment and housing authority" ~ "bristol redevelopment & housing authority",
    pha_name == "charleston-kanawha housing authority" ~ "charleston/kanawha housing authority",
    pha_name == "charlotte housing authority (inlivian)" ~ "inlivian",
    pha_name == "housing authority of columbus, georgia" ~ "housing authority of the city of columbus",
    pha_name == "district of columbia housing authority" ~ "d.c housing authority",
    pha_name == "fairfax county redevelopment and housing authority" ~ "fairfax county redevelopment & hsg authority",
    pha_name == "harrisonburg redevelopment and housing authority" ~ "harrisonburg redevelopment & housing authorit",
    pha_name == "housing & redevelopment authority of hibbing" ~ "the hra of hibbing, minnesota",
    pha_name == "kandiyohi county housing and redevelopment authority" ~ "kandiyohi county hra",
    pha_name == "king county housing authority" ~ "ha of king county",
    pha_name == "lawrence-douglas county housing authority" ~ "lawrence/douglas county housing authority",
    str_detect(pha_name, "/") ~ str_replace(pha_name, "/", "-"), #online uses slashes not dashes
    pha_name == "holyoke  housing authority" ~ "holyoke housing authority
",
    pha_name == "lexington-fayette urban county housing authority" ~ "housing authority of lexington",
    pha_name == "massachusetts dept of housing and cd" ~ "department of housing & community development",
    pha_name == "mcleod county housing and redevelopment authority" ~ "mcleod county hra",
    pha_name == "minneapolis public housing authority" ~ "pha in and for the city of minneapolis",
    pha_name == "housing authority of new haven (elm city communities)" ~ "housing authority of the city of new haven",
    pha_name == "township of neptune housing authority" ~ "neptune housing authority",
    pha_name == "new smyrna beach housing authority" ~ "housing authority of new smyrna beach",
    pha_name == "housing authority of newnan" ~ "housing authority of the city of newnan",
    pha_name == "ozark housing community" ~ "housing authority of the city of ozark",
    pha_name == "housing authority of pocatello" ~ "housing authority of the city of pocatello",
    pha_name == "city of pomona housing authority" ~ "housing authority of the city of pomona",
    pha_name == "portsmouth redevelopment and housing authority" ~ "portsmouth redevelopment & housing authority",
    pha_name == "housing authority of portland (home forward)" ~ "housing authority of portland",
    pha_name == "housing authority of the city of reno" ~ "city of reno housing authority",
    pha_name == "rosenberg housing authority" ~ "housing authority of the city of rosenberg",
    pha_name == "ruston housing" ~ "housing authority of ruston",
    pha_name == "housing authority of the county of salt lake (housing connect)" ~ "housing authority of the county of salt lake",
    pha_name == "santa clara county housing authority - housing authority of the city of san jose" ~ "santa clara county housing authority",
    pha_name == "solano county housing authority" ~ "county of solano hsg auth",
    pha_name == "south sioux city" ~ "south sioux city housing agency",
    pha_name == "tacoma housing authority" ~ "ha city of tacoma",
    pha_name == "vancouver housing authority" ~ "housing authority of the city of vancouver",
    pha_name == "washington county community development agency" ~ "washington county cda",
    pha_name == "atlanta housing" ~ "housing authority of the city of atlanta georgia",
    pha_name == "everett housing authority" ~ "ha city of everett",
    pha_name == "randolph county housing authority" ~ "housing authority of randolph county",

    T ~ pha_name
  ))

psh_phas_clean <- psh_phas %>% 
  mutate(state_ab = str_sub(states, start = 1, end = 2),
         pha_name = str_trim(tolower(name), "both"))
  

psh_phas_mtw <- left_join(psh_phas_clean, mtw_phas, by = c("state_ab", "pha_name")) %>% 
  mutate(mtw_flag = case_when( #these refuse to match or are two different ha
    pha_name == "housing authority of baltimore city" ~ 1,
    pha_name == "housing authority of champaign county" ~ 1,
    pha_name == "holyoke housing authority" & state_ab == "MA"~ 1,
    pha_name == "santa clara county housing authority" ~ 1,
    pha_name == "housing authority of the city of san jose" ~ 1,
    T ~ mtw_flag
  ))


anti_join(mtw_phas, psh_phas_clean %>% 
  mutate(state_ab = str_sub(states, start = 1, end = 2),
         pha_name = str_trim(tolower(name), "both")),
  by = c("state_ab", "pha_name"))



```


### Reshape PSH data

Want one row per housing authority/place to facilitate matching
```{r warning=FALSE}

psh_phas_wide <- psh_phas_mtw %>% 
  filter(program %in% c(1, 2, 3, 5)) %>% 
  pivot_wider(id_cols = c(PARTICIPANT_CODE, pha_name, mtw_flag, state_ab),
              names_from = c(program, program_label),
              names_prefix = "pha_",
              values_from = c(          
                 total_units,               pct_occupied,              number_reported,           pct_reported,              months_since_report,      
                 pct_movein,                people_per_unit,           people_total,              rent_per_month,            spending_per_month,       
                 hh_income,                 person_income,             pct_lt5k,                  pct_5k_lt10k,              pct_10k_lt15k,            
                 pct_15k_lt20k,             pct_ge20k,                 pct_wage_major,            pct_welfare_major,         pct_other_major,          
                 pct_median,                pct_lt50_median,           pct_lt30_median,           pct_2adults,               pct_1adult,               
                 pct_female_head,           pct_female_head_child,     pct_disabled_lt62,         pct_disabled_ge62,         pct_disabled_all,         
                 pct_lt24_head,             pct_age25_50,              pct_age51_61,              pct_age62plus,             pct_age85plus,            
                 pct_minority,              pct_black_nonhsp,          pct_native_american_nonhsp,pct_asian_pacific_nonhsp,  pct_white_nothsp,         
                 pct_black_hsp,             pct_wht_hsp,               pct_oth_hsp,               pct_hispanic,              pct_multi,                
                 months_waiting,            months_from_movein,        pct_utility_allow,         ave_util_allow,            pct_bed1,                 
                 pct_bed2,                  pct_bed3,                  pct_overhoused,            tpoverty,                  tminority,                
                 tpct_ownsfd)
                ) %>% 
  clean_names() %>% 
  mutate(across(everything(), ~ifelse(.x %in% c(-1, -4, -5), NA, .x)))

psh_places_wide <- psh_places %>% 
    filter(program %in% c(1, 2, 3, 5)) %>% 
    #mutate(row = row_number()) %>% 
    pivot_wider(names_from = c(program, program_label),
              names_prefix = "place_",
              values_from = c(          
                 total_units,               pct_occupied,              number_reported,           pct_reported,              months_since_report,      
                 pct_movein,                people_per_unit,           people_total,              rent_per_month,            spending_per_month,       
                 hh_income,                 person_income,             pct_lt5k,                  pct_5k_lt10k,              pct_10k_lt15k,            
                 pct_15k_lt20k,             pct_ge20k,                 pct_wage_major,            pct_welfare_major,         pct_other_major,          
                 pct_median,                pct_lt50_median,           pct_lt30_median,           pct_2adults,               pct_1adult,               
                 pct_female_head,           pct_female_head_child,     pct_disabled_lt62,         pct_disabled_ge62,         pct_disabled_all,         
                 pct_lt24_head,             pct_age25_50,              pct_age51_61,              pct_age62plus,             pct_age85plus,            
                 pct_minority,              pct_black_nonhsp,          pct_native_american_nonhsp,pct_asian_pacific_nonhsp,  pct_white_nothsp,         
                 pct_black_hsp,             pct_wht_hsp,               pct_oth_hsp,               pct_hispanic,              pct_multi,                
                 months_waiting,            months_from_movein,        pct_utility_allow,         ave_util_allow,            pct_bed1,                 
                 pct_bed2,                  pct_bed3,                  pct_overhoused,            tpoverty,                  tminority,                
                 tpct_ownsfd)
                ) %>% 
  clean_names() %>% 
  rename(geoid = code) %>% 
  mutate(across(everything(), ~ifelse(.x %in% c(-1, -4, -5), NA, .x)))


```


## Merge Data
### Join PSH data PHA geos

```{r}

psh_phas_geo <- left_join(psh_phas_wide, pha_geo, by = "participant_code") %>% 
  st_as_sf() %>% 
  st_make_valid() %>% 
  mutate(pha_area = st_area(geometry))

phas_anti <- anti_join(psh_phas_wide, pha_geo, by = "participant_code") #two small HA don't have shapes -FL076 RIVIERA BEACH HOUSING AUTHORITY MA187 Berkshire County Regional Housing Authority The remainder are US territories, which are excluded from this analysis.
```


### Join Cities and PSH cities data

```{r}
psh_places_geo <- left_join(census_2019, psh_places_wide, by = "geoid") %>% 
  st_transform(st_crs(psh_phas_geo)) %>% 
  st_make_valid() %>% 
  mutate(place_area = st_area(geometry))

places_anti <- anti_join(census_2019, psh_places_wide, by = "geoid")
# No PSH data for 6 cities
# Macon-Bibb County, GA
# Jurupa valley city, CA
# Jurupa City Valley, GA
# Brookhaven City, GA
# Stonecrest City, GA
# Collierville town, TN

```

### Spatial join cities and PHAs

```{r}

phas_places_join <- st_intersection(psh_places_geo, psh_phas_geo)

```

## Analysis
### PHA level for small and mid-sized cities

```{r}

all_cities_joined <- filter(phas_places_join, ! geoid %in% c("0464210", "0621230", "0637692", "0646842", "0812815", "1200410", "1245060", "1310944", "1319000", "1342425", "1349008", "1372122", "1373784", "1571550", "2148006", "2578972", "2483775", "5103320", "5367167", "1271625", "7276770", "7206593", "7214290", "7263820", "7210334", "7232522", "7252431" ))%>% 
  group_by(geoid) %>% 
  mutate(n_phas_matched = n(),
         overlap_area = st_area(geometry),
         percent_cover_city = as.double(overlap_area/place_area),
         percent_cover_pha = as.double(overlap_area/pha_area)) %>% 
  relocate(
    c(objectid,  stusab, formal_participant_name, pct_share,  sumlev, pha_level, n_phas_matched, overlap_area,
      percent_cover_city, percent_cover_pha, geometry),
    .before = pop_num) %>% 
  mutate(badmatch = if_else(percent_cover_city <.4 & percent_cover_pha <.4, 1, 0)) %>% 
  filter(badmatch != 1) %>% 
  mutate(n_phas_matched2 = n()) %>% 
  relocate(n_phas_matched2, .after = n_phas_matched)
```

``` {r}

num_serving <- as.data.frame(all_cities_joined) %>% 
  group_by(geoid, pha_level) %>% 
  mutate(num_serving = n()) %>% 
  select(geoid, NAME, pha_level, num_serving, size_type) %>% 
  distinct() %>% 
  pivot_wider(id_cols = c(geoid, NAME, size_type), names_from = pha_level, values_from = num_serving) %>% 
  # left_join(select(small_mid_explore, geoid, NAME),
  #           .,
  #           by = "geoid") %>% 
  mutate(across(c(Regional, State, Local), ~replace_na(.x, 0)),
         size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)")),
    served_by = 
      factor(
      case_when(
                          Local > 0 & Regional == 0 & State == 0 ~ "Local only",
                          Local > 0 & Regional > 0 & State == 0 ~ "Local and regional",
                          Local > 0 & Regional ==0 & State > 0 ~ "Local and state",
                          Local > 0 & Regional > 0 & State > 0 ~ "Local, regional, and state",
                          Local == 0 & Regional > 0 & State == 0 ~ "Regional only",
                          Local == 0 & Regional > 0 & State > 0 ~ "Regional and state",
                          Local == 0 & Regional == 0 & State > 0 ~ "State only",
                          T ~ "Not served"
    
  ),
      levels = c("Local only", "Local and regional", "Regional only", "Local and state", "Regional and state", "State only","Local, regional, and state",
                  "Not served"))) %>% 
  ungroup()
  

#How many states have a state HA?

```

```{r}
num_serving %>% 
  filter(size_type != "large (500k +)") %>% 
  count(served_by) %>% 
  ggplot(mapping = aes(x=served_by, y = n))+
    geom_col()+
    geom_text(mapping = aes(label = n), vjust = -1) +
    scale_y_continuous(expand = expand_scale(mult = c(0,0.1)))+
    labs(x = "PHAs service combinations",
         y = NULL,
         title = "Number of Small and Mid Sized Cities served by PHA type",
         caption = paste0("N=", nrow(num_serving %>% filter(size_type != "large (500k +)")), " small and mid sized cities"))+
    remove_ticks() +
    remove_axis()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
num_serving %>% 
  mutate(local_graph = if_else(served_by %in% c("Local only", "Local and regional", "Local and state", "Local, regional, and state"),
                               as.character(served_by),
                               "No local PHA")) %>% 
  group_by(size_type) %>% 
  count(local_graph) %>% 
  mutate(
         local_graph = factor(local_graph, levels = c("No local PHA", "Local only", "Local and regional", "Local and state", "Local, regional, and state" )),
         proportion = n/sum(n)) %>% 
  ggplot(mapping = aes(x = size_type, y = proportion, fill = local_graph))+
  geom_col(position = "fill")+
  scale_fill_manual(values = c("#d2d2d2", "#a2d4ec", "#46abdb", "#1696d2", "#12719e", "#0a4c6a"))+
  geom_text(aes(label = paste0(round(proportion*100, 0), "%")), position = position_stack(vjust = 0.5), color = "black")+
  scale_y_continuous(expand = expand_scale(mult = c(0,0.1)), labels = scales::percent, limits = c(0, 1))+
  labs(title = "Most small and mid sized cities often don't have local Public Housing Authorities",
       subtitle = "Percent of small and mid sized cities being served by PHA type",
      x = NULL,
       y = NULL,
       caption = paste0("N=", nrow(num_serving), " cities")) +  
  remove_ticks() +
  guides(color = FALSE)

#palette_urbn_main
#palette_urbn_cyan
```


```{r}
num_serving %>% 
  mutate(regional_graph = if_else(served_by %in% c("Regional only", "Local and regional", "Regional and state", "Local, regional, and state"),
                               as.character(served_by),
                               "No regional PHA")) %>% 
  group_by(size_type) %>% 
  count(regional_graph) %>% 
  mutate(
         regional_graph = factor(regional_graph, levels = c("No regional PHA", "Regional only", "Local and regional", "Regional and state", "Local, regional, and state" )),
         proportion = n/sum(n)) %>% 
  ggplot(mapping = aes(x = size_type, y = proportion, fill = regional_graph))+
  geom_col(position = "fill")+
  scale_fill_manual(values = c("#d2d2d2", "#a2d4ec", "#46abdb", "#1696d2", "#12719e", "#0a4c6a"))+
  geom_text(aes(label = paste0(round(proportion*100, 0), "%")), position = position_stack(vjust = 0.5), color = "black")+
  scale_y_continuous(expand = expand_scale(mult = c(0,0.1)), labels = scales::percent, limits = c(0, 1))+
  labs(title = "Most small and mid sized cities have regional Public Housing Authorities",
       subtitle = "Percent of small and mid sized cities being served by PHA type",x = NULL,
       y = NULL,
       caption = paste0("N=", nrow(num_serving), " cities")) +  
  remove_ticks() +
  guides(color = FALSE)





```

```{r}
num_serving %>% 
  mutate(state_graph = if_else(served_by %in% c("State only", "Local and state", "Regional and state", "Local, regional, and state"),
                               as.character(served_by),
                               "No state PHA")) %>% 
  group_by(size_type) %>% 
  count(state_graph) %>% 
  mutate(
         state_graph = factor(state_graph, levels = c("No state PHA", "State only", "Local and state", "Regional and state", "Local, regional, and state" )),
         proportion = n/sum(n)) %>% 
  ggplot(mapping = aes(x = size_type, y = proportion, fill = state_graph))+
  geom_col(position = "fill")+
  scale_fill_manual(values = c("#d2d2d2", "#a2d4ec", "#46abdb", "#1696d2", "#12719e", "#0a4c6a"))+
  geom_text(aes(label = paste0(round(proportion*100, 0), "%")), position = position_stack(vjust = 0.5), color = "black")+
  scale_y_continuous(expand = expand_scale(mult = c(0,0.1)), labels = scales::percent, limits = c(0, 1))+
  labs(title = "About half of small and mid sized cities have state Public Housing Authorities",
       subtitle = "Percent of small and mid sized cities being served by PHA type",x = NULL,
       y = NULL,
       caption = paste0("N=", nrow(num_serving), " cities")) +  
  remove_ticks() +
  guides(color = FALSE)
```




```{r}

long_num_serving <- as.data.frame(all_cities_joined) %>% 
  filter(size_type != "large (500k +)") %>% 
  group_by(geoid, pha_level) %>% 
  mutate(num_serving = n()) %>% 
  select(geoid, NAME, pha_level, num_serving) %>% 
  distinct() %>% 
  left_join(., select(num_serving, geoid, served_by)) %>% 
  group_by(served_by) %>% 
  count(pha_level) %>% 
  ungroup() %>% 
  mutate(proportion = n/nrow(num_serving))
  
long_num_serving %>% 
  ggplot(mapping = aes(x = pha_level, y = proportion, fill = served_by))+
  geom_col()+
  scale_fill_manual(values = palette_urbn_cyan)+
  geom_text(aes(label = paste0(round(proportion*100, 0), "%")), position = position_stack(vjust = .75), color = "black")+
  scale_y_continuous(expand = expand_scale(mult = c(0,0.1)), labels = scales::percent, limits = c(0, 1))+
  labs(title = "Most small and mid sized cities are served by regional housing authorities",
       subtitle = "Percentage of small and mid sized cities served by PHA type",x = NULL,
       y = NULL,
       caption = paste0("N=", nrow(num_serving %>% filter(size_type != "large (500k +)")), " small and mid sized cities")) +  
  remove_ticks() +
  guides(color = FALSE)





```

##PSH place-level analysis

Mix of households served


```{r}

census_psh_places <- 
  left_join(census_2019, psh_places_wide, by = "geoid") %>% 
  filter( ! geoid %in% c("0464210", "0621230", "0637692", "0646842", "0812815", "1200410", "1245060", "1310944", "1319000", "1342425", "1349008", "1372122", "1373784", "1571550", "2148006", "2578972", "2483775", "5103320", "5367167", "1271625", "7276770", "7206593", "7214290", "7263820", "7210334", "7232522", "7252431" ))%>% 
  as.data.frame()

```

```{r}

mix_hh_served <- census_psh_places %>% 
  select(geoid, NAME, total_units, total_units_place_1_summary_of_all_hud_programs, total_units_place_2_public_housing, total_units_place_3_housing_choice_vouchers, total_units_place_5_project_based_section_8, size_type) %>% 
  mutate(share_sub_units = total_units_place_1_summary_of_all_hud_programs/total_units,
         share_sub_cat = factor(
           case_when(
             share_sub_units < .01 ~ "Less than 1 percent",
             share_sub_units >= .01 & share_sub_units <.03 ~ "1 to 3 percent",
             share_sub_units >= .03 & share_sub_units <.05 ~ "3 to 5 percent",
             share_sub_units >= .05 & share_sub_units <.07 ~ "5 to 7 percent",
              share_sub_units >= .07 & share_sub_units <.09 ~ "7 to 9 percent",
             share_sub_units >= .09 ~ "9 percent or more",
         ),
         levels = c("Less than 1 percent",
              "1 to 3 percent",
              "3 to 5 percent",
              "5 to 7 percent",
               "7 to 9 percent",
              "9 percent or more"))
         )

```

```{r}
mix_hh_served %>% 
  filter(!is.na(share_sub_cat), size_type != "large (500k +)") %>% 
  #group_by(size_type) %>% 
  count(share_sub_cat) %>% 
ggplot()+
  geom_col(mapping = aes(x = share_sub_cat, y = n))+
  labs(title = "Share of subsidized housing in small and mid sized cities",
       subtitle = "Subsidized units as a percentage of total units",
       y = "Number of cities",
       x = "Percent subsidized",
       caption = paste0("N=", nrow(num_serving %>% filter(size_type != "large (500k +)")), " small and mid sized cities"))
```
```{r}

mix_hh_served %>% 
  pivot_longer(starts_with("total_units"), names_to = "program", values_to = "units") %>% 
  group_by(geoid, size_type) %>% 
  mutate(total_sub_units = max(units, na.rm = TRUE)) %>% 
  #filter(program != "total_units_place_1_summary_of_all_hud_programs") %>% 
  ungroup() %>%
  group_by(program) %>% 
  summarize(`Units` = sum(units, na.rm = TRUE))
            

```

```{r}

mix_hh_served %>% 
  pivot_longer(starts_with("total_units"), names_to = "program", values_to = "units") %>% 
  filter(! program %in% c("total_units_place_1_summary_of_all_hud_programs", "total_units")) %>% 
  mutate(program = case_when(
    program == "total_units_place_2_public_housing" ~ "Public housing",
    program == "total_units_place_3_housing_choice_vouchers" ~ "Housing choice vouchers",
    program == "total_units_place_5_project_based_section_8" ~ "Project based section 8"
  )) %>% 
  group_by(size_type, program) %>% 
  summarize(units = sum(units, na.rm = TRUE)) %>% 
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = units, fill = program), position = "fill") +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = scales::percent) +
  labs(title = "Larger cities have slightly higher shares of public housing than small and mid-sized cities",
       subtitle = "Share of subsidized units by program",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)

# how many places had no vouchers or no public housing at all

mix_hh_served %>% 
  select(geoid, NAME, total_units, total_units_place_1_summary_of_all_hud_programs, total_units_place_2_public_housing, total_units_place_3_housing_choice_vouchers, total_units_place_5_project_based_section_8, size_type) %>% 
  count(is.na(total_units_place_3_housing_choice_vouchers), is.na(total_units_place_2_public_housing))

```


Total households served


```{r}
mix_hh_served %>% 
  group_by(size_type) %>% 
  summarize(sum = sum(total_units_place_1_summary_of_all_hud_programs, na.rm = TRUE)) %>% 
  arrange(desc(size_type)) %>%
  mutate(
         ypos = cumsum(sum)-.5*sum) %>% 
  ggplot()+
  geom_bar(aes(x="", y=sum, fill = size_type), stat="identity", width = 1)+
  coord_polar("y", start = 0)+
  geom_text(aes(x = "", y = ypos, label = scales::comma(sum), color = size_type))+
  scale_color_manual(values = c("black", "black", "white", "black"))+
  remove_ticks() +
  remove_axis() +
    labs(title = "Most urban subsidized housing is found in small and mid-sized cities",
       subtitle = "Share of subsidized units by program",
        x = NULL,
       y = NULL)+
  guides(color = FALSE,
         label = FALSE)+
  theme_void()+
  theme(legend.title = element_blank())

  
  
  
```

```{r}
mix_hh_served %>% 

  group_by(size_type) %>% 
  summarize(units_share = sum(total_units_place_1_summary_of_all_hud_programs, na.rm = TRUE)/sum(total_units, na.rm = TRUE)) %>% 
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = units_share)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = scales::percent) +
  labs(title = "Larger cities have slightly higher shares of subsidized units than small and mid-sized cities",
       subtitle = "Share of subsidized units by city size",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)

```

Race/Ethnicity of HH served
```{r}
race_places <- census_psh_places %>% 
  select(geoid, size_type, NAME, pct_white_nothsp_place_1_summary_of_all_hud_programs, pct_asian_pacific_nonhsp_place_1_summary_of_all_hud_programs, pct_black_nonhsp_place_1_summary_of_all_hud_programs, pct_native_american_nonhsp_place_1_summary_of_all_hud_programs,  pct_hispanic_place_1_summary_of_all_hud_programs, pct_multi_place_1_summary_of_all_hud_programs, number_reported_place_1_summary_of_all_hud_programs) %>% 
  mutate(
         across(starts_with("pct"), ~.x*number_reported_place_1_summary_of_all_hud_programs)
         ) %>% 
  pivot_longer(starts_with("pct_"), names_to = "race_eth", values_to = "value") %>% 
  mutate(race_eth = case_when(
    str_detect(race_eth, "black") ~ "Black",
    str_detect(race_eth, "white") ~ "White",
    str_detect(race_eth, "native") ~ "Native American",
    str_detect(race_eth, "asian") ~ "Asian/Pacific Islander",
    str_detect(race_eth, "hispanic") ~ "Hispanic",
    str_detect(race_eth, "multi") ~ "Two or more races"
  ))

race_places %>% 
  group_by(size_type, race_eth) %>% 
  summarize(count = sum(value, na.rm = TRUE)) %>% 
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = count, fill = race_eth), position = "fill") +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = scales::percent) +
  labs(title = "Small and mid-sized cities subsidized households are whiter than large cities",
       subtitle = "Share of subsidized units by race and ethnicity",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)

```


Income of HH served
```{r}
census_psh_places %>% 
  select(hh_income_place_1_summary_of_all_hud_programs, size_type) %>% 
  group_by(size_type) %>% 
  summarize(avg_income = mean(hh_income_place_1_summary_of_all_hud_programs, na.rm = TRUE)) %>% 
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = avg_income)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = scales::dollar) +
  labs(title = "Small and mid sized subsidized households have slightly higher inocmes than large cities",
       subtitle = "Average household income by city size",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)

```

```{r}
census_psh_places %>% 
  select(hh_income_place_1_summary_of_all_hud_programs, size_type)%>% 
  filter(!is.na(hh_income_place_1_summary_of_all_hud_programs), size_type != "large (500k +)") %>% 
  mutate(income_bracket = factor(case_when(
    hh_income_place_1_summary_of_all_hud_programs < 10000 ~ "Less than $10,000",
    hh_income_place_1_summary_of_all_hud_programs >= 10000 & hh_income_place_1_summary_of_all_hud_programs < 15000 ~ "$10,000 - $15,000",
    hh_income_place_1_summary_of_all_hud_programs >= 15000 & hh_income_place_1_summary_of_all_hud_programs < 20000 ~ "$15,000 - $20,000",
    hh_income_place_1_summary_of_all_hud_programs >= 20000 & hh_income_place_1_summary_of_all_hud_programs < 25000 ~ "$20,000 - $25,000",
    hh_income_place_1_summary_of_all_hud_programs >= 25000 & hh_income_place_1_summary_of_all_hud_programs < 30000 ~ "$25,000 - $30,000",
    hh_income_place_1_summary_of_all_hud_programs >= 30000 ~ "$30,000 or greater"
  ),levels = c(
    "Less than $10,000",
    "$10,000 - $15,000",
    "$15,000 - $20,000",
    "$20,000 - $25,000",
    "$25,000 - $30,000",
    "$30,000 or greater"
  ))) %>% 
  count(income_bracket) %>% 
ggplot()+
  geom_col(mapping = aes(x = income_bracket, y = n))+
  labs(title = "Subsidized households have average incomes between 10 and 20k in most small and mid-sized cities",
       subtitle = "Number of small and mid sized cities by income group",
       #y = "Number of cities",
       x = "Income range",
       caption = paste0("N=", nrow(num_serving %>% filter(size_type != "large (500k +)")), " small and mid sized cities"))
```



Household comp of HH served

```{r}
census_psh_places %>% 
  select(people_per_unit_place_1_summary_of_all_hud_programs, size_type) %>% 
  group_by(size_type) %>% 
  summarize(avg_hh_size = mean(people_per_unit_place_1_summary_of_all_hud_programs, na.rm = TRUE)) %>% 
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = avg_hh_size)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1))) +
  labs(title = "Household size is consistent across city types",
       subtitle = "Average household size by city size",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)
```



```{r}
census_psh_places %>% 
  select(people_per_unit_place_1_summary_of_all_hud_programs, size_type)%>% 
  filter(!is.na(people_per_unit_place_1_summary_of_all_hud_programs), size_type != "large (500k +)") %>% 
  mutate(hhsize_bracket = factor(case_when(
    people_per_unit_place_1_summary_of_all_hud_programs < 2 ~ "Less than 2",
    people_per_unit_place_1_summary_of_all_hud_programs >= 2 & people_per_unit_place_1_summary_of_all_hud_programs < 3 ~ "2 - 3",
    people_per_unit_place_1_summary_of_all_hud_programs >= 3 & people_per_unit_place_1_summary_of_all_hud_programs < 4 ~ "3 - 4",
    people_per_unit_place_1_summary_of_all_hud_programs >= 4 ~ "4 or more"
  ),levels = c(
    "Less than 2",
    "2 - 3",
    "3 - 4",
    "4 or more"
  ))) %>% 
  count(hhsize_bracket) %>% 
ggplot()+
  geom_col(mapping = aes(x = hhsize_bracket, y = n))+
  labs(title = "Subsidized households have average household sizes of 2-3 people in small and mid-sized cities",
       subtitle = "Number of small and mid sized cities by income group",
       #y = "Number of cities",
       x = "houshold size range",
       caption = paste0("N=", nrow(num_serving %>% filter(size_type != "large (500k +)")), " small and mid sized cities"))


```

Neighborhood poverty rate

```{r}

census_psh_places %>% 
  select(tpoverty_place_1_summary_of_all_hud_programs, size_type) %>% 
  group_by(size_type) %>% 
  summarize(avg_pov_share = mean(tpoverty_place_1_summary_of_all_hud_programs/100, na.rm = TRUE)) %>% 
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = avg_pov_share)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = (scales::percent)) +
  labs(title = "Subsidized households in small and mid sized cities are less likely to live in impoverished neighborhoods",
       subtitle = "Average share of housholds living in impoverished neighborhood by city type",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)


```

```{r}

census_psh_places %>% 
  select(pct_disabled_lt62_place_1_summary_of_all_hud_programs, pct_disabled_ge62_place_1_summary_of_all_hud_programs, pct_age62plus_place_1_summary_of_all_hud_programs, size_type) %>% 
  mutate_if(is.numeric, ~./100) %>% 
  group_by(size_type) %>% 
  summarize(avg_disabled_share = mean((pct_disabled_lt62_place_1_summary_of_all_hud_programs*
                                        (1-(pct_age62plus_place_1_summary_of_all_hud_programs))) +
                                      (pct_disabled_ge62_place_1_summary_of_all_hud_programs*
                                        ((pct_age62plus_place_1_summary_of_all_hud_programs))), na.rm = TRUE)) %>% #weighted average
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = avg_disabled_share)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = (scales::percent)) +
  labs(title = "Average share of head of households who are disabled person is consistent across city sizes",
       subtitle = "Average share of households with a disabled head by city type",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)


```

Average sub amount

```{r}
census_psh_places %>% 
  select(spending_per_month_place_1_summary_of_all_hud_programs, size_type) %>% 
  group_by(size_type) %>% 
  summarize(avg_hh_expend = mean(spending_per_month_place_1_summary_of_all_hud_programs, na.rm = TRUE)) %>% 
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = avg_hh_expend)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = scales::dollar) +
  labs(title = "Household subsidy amount size is consistent across city types",
       subtitle = "Average monthly household subsidy by city size",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)
```


```{r}
census_psh_places %>% 
  select(pct_lt50_median_place_1_summary_of_all_hud_programs, pct_lt30_median_place_1_summary_of_all_hud_programs, size_type) %>% 
  pivot_longer(cols = starts_with("pct"), names_to = "series", values_to = "percentage") %>% 
  mutate(series = case_when(
    series == "pct_lt50_median_place_1_summary_of_all_hud_programs" ~ "very low income",
    series == "pct_lt30_median_place_1_summary_of_all_hud_programs" ~ "extremely low income"
  )) %>% 
  group_by(size_type, series) %>% 
  summarize(avg_share_li = mean(percentage/100, na.rm = TRUE)) %>% 
  mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = size_type, y = avg_share_li, fill = series), position = "dodge") +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = scales::percent) +
  labs(title = "Share of Households that are Low Income is consistent across city size",
       subtitle = "Average share of households with extremely low and very low income by city size",
        x = NULL,
       y = NULL) +  
  remove_ticks() +
  guides(color = FALSE)
```


check on... 1/5/21
-disability seems low - done
-add average housing assistance amount - done
-how many state phas are there - done
-how many w/no vouchers or no public housing - done
-proportion that live in low/med/high  pov - all we have is very low income and extremely low income (below 50% ami and below 30% ami) - done
-how does the data define high poverty (% of the population below poverty level in the census tract where HUD assisted family resides)

small analysis for Kathy/Martha week of 1/5
-PHAs listed under the small PHA cohort in this list from HUD: https://www.hud.gov/program_offices/public_indian_housing/programs/ph/mtw/mtwagencies
-how many people they serve
-the demographics you've been putting together, etc.
-population of the cities/counties they serve, so we can know how many fall in our target range. 

#check mtw phas list
```{r}

mtw_part_codes <- psh_phas_mtw %>% 
  filter(mtw_flag == 1) %>% 
  select(pha_name, PARTICIPANT_CODE, mtw_flag) %>% 
  distinct() %>% 
  janitor::clean_names()

full_join(mtw_part_codes, mtw_phas, by = "pha_name") %>% 
  campfin::flag_dupes(pha_name)

#alaska, delaware, match to two phas based on name
#i think alaska should be both - two different phas - one for voucher and one for PH
#delware same thing
```


```{r}

mtw_serving <- as.data.frame(all_cities_joined) %>% 
  filter(mtw_flag==1) %>% 
  group_by(participant_code, pha_level) %>% 
  mutate(num_serving = n()) %>% 
  select(participant_code, NAME, num_serving, size_type, pha_level) %>% 
  #filter(pha_level != "State") %>% 
  distinct() %>% 
  left_join(mtw_part_codes,., by = "participant_code")

mtw_serving %>% 
  distinct(participant_code, pha_level) %>% 
  group_by(pha_level) %>% 
  count()

#total cities served by mtw agencies
mtw_serving %>% 
  mutate(target_size = case_when(
    size_type %in% c("small (50-100k)", "small-mid (100-150k)", "mid (150-500k)") ~ "small or mid sized city",
    T ~ "not target city"
  )) %>% 
  group_by(target_size) %>% 
  count()

#how many mtw phas serve a city
mtw_serving %>% 
  group_by(pha_name) %>% 
  summarize(smallest_served = min(size_type)) %>% 
  count(smallest_served)

#how many target cities does each mtw pha serve
mtw_serving %>%
  mutate(target_size = case_when(
    size_type %in% c("small (50-100k)", "small-mid (100-150k)", "mid (150-500k)") ~ 1,
    T ~ 0
  )) %>% 
  group_by(pha_name) %>% 
  summarize(target_cities_served = sum(target_size))

#how many mtw agencies serve at least one target sized city
mtw_serving %>% 
  mutate(target_size = case_when(
    size_type %in% c("small (50-100k)", "small-mid (100-150k)", "mid (150-500k)") ~ 1,
    T ~ 0
  )) %>% 
  group_by(pha_name) %>% 
  summarize(target_cities_served = max(target_size)) %>% 
  count(target_cities_served)

```


```{r}

mtw_demo <- psh_phas_wide %>%
  #filter(mtw_flag == 1) %>% 
  select(participant_code, mtw_flag,
         pct_white_nothsp_pha_1_summary_of_all_hud_programs, pct_asian_pacific_nonhsp_pha_1_summary_of_all_hud_programs, pct_black_nonhsp_pha_1_summary_of_all_hud_programs, pct_native_american_nonhsp_pha_1_summary_of_all_hud_programs,  pct_hispanic_pha_1_summary_of_all_hud_programs, pct_multi_pha_1_summary_of_all_hud_programs, number_reported_pha_1_summary_of_all_hud_programs,
         total_units_pha_1_summary_of_all_hud_programs,
         total_units_pha_1_summary_of_all_hud_programs, total_units_pha_2_public_housing, total_units_pha_3_housing_choice_vouchers) %>% 
  mutate(mtw_cat = ifelse(is.na(mtw_flag), "Not MTW", "MTW"),
         across(starts_with("pct"), ~.x*number_reported_pha_1_summary_of_all_hud_programs)
         ) %>% 
  pivot_longer(starts_with("pct_"), names_to = "race_eth", values_to = "value") %>% 
  mutate(race_eth = case_when(
    str_detect(race_eth, "black") ~ "Black",
    str_detect(race_eth, "white") ~ "White",
    str_detect(race_eth, "native") ~ "Native American",
    str_detect(race_eth, "asian") ~ "Asian/Pacific Islander",
    str_detect(race_eth, "hispanic") ~ "Hispanic",
    str_detect(race_eth, "multi") ~ "Two or more races"
  ))


```

```{r}
mtw_demo %>% 
  group_by(race_eth, mtw_cat) %>% 
  summarize(count = sum(value, na.rm = TRUE)) %>% 
  #mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = mtw_cat, y = count, fill = race_eth), position = "fill") +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = scales::percent) +
  labs(title = "MTW agency households are more likely to be black and less likely to be white",
       subtitle = "Share of subsidized households by race and ethnicity",
        x = NULL,
       y = NULL,
       caption = paste0("N =", nrow(mtw_phas), " MTW agencies, ", nrow(psh_phas_wide)-nrow(mtw_phas), " non MTW agencies")) +  
  remove_ticks() +
  guides(color = FALSE)
```

```{r}
psh_phas_wide %>%
  #filter(mtw_flag == 1) %>% 
  select(participant_code, mtw_flag,
         total_units_pha_1_summary_of_all_hud_programs,
         total_units_pha_1_summary_of_all_hud_programs, total_units_pha_2_public_housing, total_units_pha_3_housing_choice_vouchers) %>% 
  mutate(mtw_cat = ifelse(is.na(mtw_flag), "Not MTW", "MTW"),
         across(starts_with("pct"), ~.x*number_reported_pha_1_summary_of_all_hud_programs)
         ) %>% 
  pivot_longer(starts_with("total_units"), names_to = "program", values_to = "units") %>% 
  filter(! program %in% c("total_units_pha_1_summary_of_all_hud_programs", "total_units")) %>% 
  mutate(program = case_when(
    program == "total_units_pha_2_public_housing" ~ "Public housing",
    program == "total_units_pha_3_housing_choice_vouchers" ~ "Housing choice vouchers",
    #program == "total_units_pha_5_project_based_section_8" ~ "Project based section 8"
  )) %>% 
  group_by(mtw_cat, program) %>% 
  summarize(units = sum(units, na.rm = TRUE)) %>% 
  #mutate(size_type = factor(size_type, levels = c("small (50-100k)", "small-mid (100-150k)",  "mid (150-500k)", "large (500k +)"))) %>% 
  ggplot()+
  geom_col(mapping = aes(x = mtw_cat, y = units, fill = program), position = "fill") +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = scales::percent) +
  labs(title = "MTW agencies have slightly higher proportions of housing vouchers as a percentage of total subsidized units",
       subtitle = "Share of subsidized units by program",
        x = NULL,
       y = NULL,
       caption = paste0("N =", nrow(mtw_phas), " MTW agencies, ", nrow(psh_phas_wide)-nrow(mtw_phas), " non MTW agencies")) +  
  remove_ticks() +
  guides(color = FALSE)
```

```{r}
psh_phas_wide %>%
  filter(mtw_flag == 1) %>% 
  select(participant_code, mtw_flag,
         total_units_pha_1_summary_of_all_hud_programs) %>% 
  mutate(hhs_bracket = factor(case_when(
    total_units_pha_1_summary_of_all_hud_programs < 1000 ~ "Less than 1000",
    total_units_pha_1_summary_of_all_hud_programs >= 1000 & total_units_pha_1_summary_of_all_hud_programs < 5000 ~ "1,000-5,000",
    total_units_pha_1_summary_of_all_hud_programs >= 5000 & total_units_pha_1_summary_of_all_hud_programs < 10000 ~ "5,000-10,000",
    total_units_pha_1_summary_of_all_hud_programs >= 10000 ~ "10,000 or more"
  ),levels = c(
    "Less than 1000",
    "1,000-5,000",
    "5,000-10,000",
    "10,000 or more"
  ))) %>% 
  count(hhs_bracket) %>% 
ggplot()+
  geom_col(mapping = aes(x = hhs_bracket, y = n))+
  labs(title = "Most MTW agencies serve less than 5000 households",
       subtitle = "Distribution of # of households served",
       y = "Number of PHAs",
       x = "# of households served",
       caption = paste0("N=", 80))
```




